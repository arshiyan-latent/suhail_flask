<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white flex flex-col md:flex-row">

  <!-- Sidebar -->
  <aside class="w-full md:w-72 backdrop-blur-md bg-white/10 border-b md:border-b-0 md:border-r border-white/20 p-4 flex flex-col space-y-4 text-sm">
    <div class="text-lg font-semibold text-white/90">Suhail</div>

    <!-- New Chat Button -->
    <button id="newChatBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-xl shadow hover:from-purple-600 hover:to-pink-600 transition-all">
      + New Chat
    </button>

    <!-- Flows -->
    <div>
    <span id="user_id" hidden >{{current_user.id}}</span>
      <h3 class="text-xs font-semibold text-white/70 mb-2">Flows</h3>
      <ul class="space-y-1">
        {% if current_user.role == 'admin' %}
          <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer"><a href="/admin/users">Admin Dashboard</a></li>
          <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">Manager's Dashboard</li>
        {% elif current_user.role == 'manager' %}
        <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">Manager's Dashboard</li>

        {% endif %}
        <!-- <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">General Chat</li>
        <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">Personal Assistant</li> -->
      </ul>
    </div>

    <!-- Recent Chats -->
    <div class="flex-1 overflow-y-auto mt-2">
      <h3 class="text-xs font-semibold text-white/70 mb-2">Recent Chats</h3>
      <ul id="recentChats" class="space-y-1">
        {% for chat in recent_chats %}
          <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer truncate">
            {{ chat.title }}
          </li>
        {% else %}
          <li class="text-white/50 italic">No recent chats</li>
        {% endfor %}
      </ul>
    </div>
  </aside>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col text-sm">

    <!-- Navbar -->
    <nav class="flex justify-between items-center px-4 py-3 backdrop-blur-md bg-white/10 border-b border-white/20">
      <div class="text-lg font-medium truncate">Welcome, {{ current_user.username }}</div>
      <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white hover:bg-white/30 cursor-pointer">
        <a href="/logout"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5.121 17.804A9.953 9.953 0 0112 15c2.21 0 4.245.715 5.879 1.92M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg></a>
      </div>
    </nav>

    <!-- Chat Window -->
    <div id="chatWindow" class="flex-1 p-4 space-y-3 overflow-y-auto text-sm">
      <!-- Messages will appear here -->
    </div>

    <!-- Input Area -->
    <form id="chatForm" class="p-3 border-t border-white/20 bg-white/10 backdrop-blur-md flex space-x-3">
      <input type="text" id="chatInput" placeholder="Type a message..."
        class="flex-1 px-3 py-2 rounded-xl bg-white/10 border border-white/20 placeholder-white/50 text-white focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all text-sm" />
      <button
        type="submit"
        class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-5 py-2 rounded-xl shadow hover:from-purple-600 hover:to-pink-600 transition-all text-sm"
      >
        Send
      </button>
    </form>
  </div>

  <!-- JavaScript -->
  <script>

  const form = document.getElementById('chatForm');
  const input = document.getElementById('chatInput');
  const chatWindow = document.getElementById('chatWindow');
  const recentChats = document.getElementById('recentChats');
  const user_id = document.getElementById('user_id').innerText;
  console.log(user_id)
  let currentChatId = null;
  let chatCreated = false;

  const renderMarkdownBubble = (markdown, className) => {
    const bubble = document.createElement('div');
    bubble.className = className;
    bubble.innerHTML = marked.parse(markdown);
    chatWindow.appendChild(bubble);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  };

  async function createNewChatAndAssign() {
    const res = await fetch('/v1/chat/newchat', { method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({user_id: user_id})
    });
    const data = await res.json();
    currentChatId = data.id;
    chatCreated = true;

    const li = document.createElement('li');
    li.className = "p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer truncate";
    li.textContent = data.title || data.id;
    li.dataset.chatId = data.id;
    li.addEventListener('click', () => loadChatById(data.id));
    recentChats.prepend(li);
  }

  // Auto-create chat ID on first typing if needed
  input.addEventListener('input', async () => {
    if (!chatCreated && input.value.trim()) {
      await createNewChatAndAssign();
    }
  });

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    if (!chatCreated) {
      await createNewChatAndAssign();
    }

    renderMarkdownBubble(message, "max-w-xs bg-purple-600 px-4 py-2 rounded-xl self-end ml-auto");
    input.value = '';

    const typingBubble = document.createElement('div');
    typingBubble.className = "max-w-xs bg-white/10 px-4 py-2 rounded-xl self-start flex items-center space-x-2";
    typingBubble.innerHTML = `
      <svg class="w-4 h-4 animate-spin text-white opacity-50" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg>
      <span class="text-white/70 text-xs">Bot is typing...</span>
    `;
    chatWindow.appendChild(typingBubble);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    try {
      const response = await fetch('/v1/chat/salesrep', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message, chat_id: currentChatId })
      });

      const data = await response.json();
      typingBubble.remove();
      renderMarkdownBubble(data || "No response", "max-w-xs bg-white/10 px-4 py-2 rounded-xl self-start");
    } catch (error) {
      typingBubble.remove();
      renderMarkdownBubble("**Error:** Unable to get a response from the server.", "max-w-xs bg-red-600 px-4 py-2 rounded-xl self-start");
    }
  });

  async function loadChatById(chatId) {
    currentChatId = chatId;
    chatCreated = true;
    chatWindow.innerHTML = '';
    input.value = '';

    try {
      const res = await fetch(`/v1/chat/loadchat/${chatId}`);
      const data = await res.json();

      (data.messages || []).forEach(msg => {
        renderMarkdownBubble(
          msg.role === "user" ? msg.content : "**Bot:** " + msg.content,
          msg.role === "user"
            ? "max-w-xs bg-purple-600 px-4 py-2 rounded-xl self-end ml-auto"
            : "max-w-xs bg-white/10 px-4 py-2 rounded-xl self-start"
        );
      });
    } catch (err) {
      renderMarkdownBubble("**Error:** Couldn't load chat history.", "max-w-xs bg-red-600 px-4 py-2 rounded-xl self-start");
    }
  }

  // + New Chat button click
  document.getElementById('newChatBtn')?.addEventListener('click', async () => {
    await createNewChatAndAssign();
    chatWindow.innerHTML = '';
    input.value = '';
  });

  // Attach listener to server-rendered chat list
  document.querySelectorAll('#recentChats li').forEach(li => {
    li.addEventListener('click', () => {
      const chatId = li.dataset.chatId;
      loadChatById(chatId);
    });
  });
</script>






</script>

</body>
</html>
