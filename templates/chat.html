<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white flex flex-col md:flex-row">

  <!-- Sidebar -->
  <aside class="w-full md:w-72 backdrop-blur-md bg-white/10 border-b md:border-b-0 md:border-r border-white/20 p-4 flex flex-col space-y-4 text-sm">
    <div class="text-lg font-semibold text-white/90">Suhail</div>

    <!-- New Chat Button -->
    <button id="newChatBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-xl shadow hover:from-purple-600 hover:to-pink-600 transition-all">
      + New Chat
    </button>

    <!-- Flows -->
    <div>
    <span id="user_id" hidden >{{current_user.id}}</span>
      <h3 class="text-xs font-semibold text-white/70 mb-2">Flows</h3>
      <ul class="space-y-1">
        {% if current_user.role == 'admin' %}
          <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer"><a href="/admin/users">Admin Dashboard</a></li>
          <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">Manager's Dashboard</li>
        {% elif current_user.role == 'manager' %}
        <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">Manager's Dashboard</li>

        {% endif %}
        <!-- <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">General Chat</li>
        <li class="p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer">Personal Assistant</li> -->
      </ul>
    </div>

    <!-- Clients -->
    <div>
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-xs font-semibold text-white/70">Clients</h3>
        <button id="addClientBtn" class="w-5 h-5 rounded-full bg-green-500/20 hover:bg-green-500/40 flex items-center justify-center text-white/70 hover:text-white transition-all cursor-pointer" title="Add new client">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
        </button>
      </div>
      <ul id="clientsList" class="space-y-1">
        {% for client in clients %}
          <li class="client-item group p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer transition-all flex items-center justify-between" 
              data-client-name="{{ client.name }}"
              title="Start chat with {{ client.name }}">
            <span class="client-name flex-1">{{ client.name }}</span>
            <div class="client-actions opacity-0 group-hover:opacity-100 transition-opacity flex space-x-1 ml-2">
              <button class="edit-client-btn w-5 h-5 rounded bg-blue-500/20 hover:bg-blue-500/40 flex items-center justify-center text-xs" title="Edit client name">
                ‚úèÔ∏è
              </button>
              <button class="delete-client-btn w-5 h-5 rounded bg-red-500/20 hover:bg-red-500/40 flex items-center justify-center text-xs" title="Delete client">
                üóëÔ∏è
              </button>
            </div>
          </li>
        {% else %}
          <li class="text-white/50 italic">No clients available</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Recent Chats -->
    <div class="flex-1 overflow-y-auto mt-2">
      <h3 class="text-xs font-semibold text-white/70 mb-2">Recent Chats</h3>
      <ul id="recentChats" class="space-y-1">
        {% for chat in recent_chats %}
          <button onclick="loadChatById('{{ chat.id }}')"
            class="w-full flex justify-between items-center text-left bg-white/10 rounded-md px-4 py-2 mt-2">
            <span>{{ chat.title }}</span>
            <span onclick="event.stopPropagation(); renameChat('{{ chat.id }}')"
                  class="text-yellow-400 hover:text-yellow-300 cursor-pointer ml-2 text-sm">
              ‚úèÔ∏è
            </span>
          </button>
        {% else %}
          <li class="text-white/50 italic">No recent chats</li>
        {% endfor %}
      </ul>
    </div>
  </aside>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col text-sm">

    <!-- Navbar -->
    <nav class="flex justify-between items-center px-4 py-3 backdrop-blur-md bg-white/10 border-b border-white/20">
      <div class="text-lg font-medium truncate">Welcome, {{ current_user.username }}</div>
      <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white hover:bg-white/30 cursor-pointer">
        <a href="/logout"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5.121 17.804A9.953 9.953 0 0112 15c2.21 0 4.245.715 5.879 1.92M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg></a>
      </div>
    </nav>

    <!-- Chat Window -->
    <div id="chatWindow" class="flex-1 p-4 space-y-3 overflow-y-auto text-sm">
      <!-- Messages will appear here -->
    </div>

    <!-- Input Area -->
    <form id="chatForm" class="p-3 border-t border-white/20 bg-white/10 backdrop-blur-md flex space-x-3">
      <input type="text" id="chatInput" placeholder="Type a message..."
        class="flex-1 px-3 py-2 rounded-xl bg-white/10 border border-white/20 placeholder-white/50 text-white focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all text-sm" />
      <button
        type="submit"
        class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-5 py-2 rounded-xl shadow hover:from-purple-600 hover:to-pink-600 transition-all text-sm"
      >
        Send
      </button>
    </form>
  </div>

    <!-- Add Client Modal -->
  <div id="addClientModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border border-white/20">
      <h3 class="text-lg font-semibold text-white mb-4">Add New Client</h3>
      <form id="addClientForm">
        <input 
          type="text" 
          id="clientNameInput" 
          placeholder="Enter client name..." 
          class="w-full p-3 rounded-lg bg-white/10 border border-white/20 placeholder-white/50 text-white focus:outline-none focus:ring-2 focus:ring-purple-400 mb-4"
          required
        >
        <div class="flex space-x-3">
          <button 
            type="submit" 
            class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 px-4 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all"
          >
            Create Client
          </button>
          <button 
            type="button" 
            id="cancelClientBtn"
            class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-all"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Client Modal -->
  <div id="editClientModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border border-white/20">
      <h3 class="text-lg font-semibold text-white mb-4">Edit Client Name</h3>
      <form id="editClientForm">
        <input 
          type="text" 
          id="editClientNameInput" 
          placeholder="Enter new client name..." 
          class="w-full p-3 rounded-lg bg-white/10 border border-white/20 placeholder-white/50 text-white focus:outline-none focus:ring-2 focus:ring-purple-400 mb-4"
          required
        >
        <div class="flex space-x-3">
          <button 
            type="submit" 
            class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all"
          >
            Update Client
          </button>
          <button 
            type="button" 
            id="cancelEditClientBtn"
            class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-all"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- JavaScript -->
  <script>

  const form = document.getElementById('chatForm');
  const input = document.getElementById('chatInput');
  const chatWindow = document.getElementById('chatWindow');
  const recentChats = document.getElementById('recentChats');
  const user_id = document.getElementById('user_id').innerText;
  console.log(user_id)
  let currentChatId = null;
  let chatCreated = false;
  let currentClientName = null; // Track selected client

  const renderMarkdownBubble = (markdown, className) => {
    const bubble = document.createElement('div');
    bubble.className = className;
    bubble.innerHTML = marked.parse(markdown);
    chatWindow.appendChild(bubble);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  };

  async function createNewChatAndAssign(clientName = null) {
    const requestBody = {user_id: user_id};
    if (clientName) {
      requestBody.client_name = clientName;
    }

    const res = await fetch('/v1/chat/newchat', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });
    const data = await res.json();
    currentChatId = data.id;
    currentClientName = clientName;
    chatCreated = true;

    const li = document.createElement('li');
    li.className = "p-2 rounded bg-white/10 hover:bg-white/20 cursor-pointer truncate";
    li.textContent = clientName ? `Chat with ${clientName}` : 'General Chat';
    li.dataset.chatId = data.id;
    li.addEventListener('click', () => loadChatById(data.id));
    recentChats.prepend(li);
  }

  // Auto-create chat ID on first typing if needed
  input.addEventListener('input', async () => {
    if (!chatCreated && input.value.trim()) {
      await createNewChatAndAssign(currentClientName);
    }
  });

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    if (!chatCreated) {
      await createNewChatAndAssign();
    }

    renderMarkdownBubble(message, "max-w-xs bg-purple-600 px-4 py-2 rounded-xl self-end ml-auto");
    input.value = '';

    const typingBubble = document.createElement('div');
    typingBubble.className = "max-w-xs bg-white/10 px-4 py-2 rounded-xl self-start flex items-center space-x-2";
    typingBubble.innerHTML = `
      <svg class="w-4 h-4 animate-spin text-white opacity-50" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg>
      <span class="text-white/70 text-xs">Bot is typing...</span>
    `;
    chatWindow.appendChild(typingBubble);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    try {
      const response = await fetch('/v1/chat/salesrep', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message, chat_id: currentChatId })
      });

      const data = await response.json();
      typingBubble.remove();
      renderMarkdownBubble(data || "No response", "max-w-xs bg-white/10 px-4 py-2 rounded-xl self-start");
    } catch (error) {
      typingBubble.remove();
      renderMarkdownBubble("**Error:** Unable to get a response from the server.", "max-w-xs bg-red-600 px-4 py-2 rounded-xl self-start");
    }
  });

  //WILL NEED UPDATE
  async function loadChatById(chatId) {
    if (!chatId) {
      console.error("Chat ID is undefined. Skipping load.");
      return;
    }
    currentChatId = chatId;
    chatCreated = true;
    chatWindow.innerHTML = '';
    input.value = '';

    try {
      const res = await fetch(`/v1/chat/loadchat/${chatId}`);
      if (!res.ok) throw new Error('Failed to load chat');

      const messages = await res.json();

      messages.forEach(msg => {
        renderMarkdownBubble(
          msg.role === "user" ? msg.content : "**Bot:** " + msg.content,
          msg.role === "user"
            ? "max-w-xs bg-purple-600 px-4 py-2 rounded-xl self-end ml-auto"
            : "max-w-xs bg-white/10 px-4 py-2 rounded-xl self-start"
        );
      });
    } catch (err) {
      renderMarkdownBubble("**Error:** Couldn't load chat history.", "max-w-xs bg-red-600 px-4 py-2 rounded-xl self-start");
    }
}

  // + New Chat button click
  document.getElementById('newChatBtn')?.addEventListener('click', async () => {
    // Reset client selection
    currentClientName = null;
    highlightSelectedClient(null);
    
    // Update header back to welcome message
    const chatHeader = document.querySelector('nav div:first-child');
    if (chatHeader) {
      chatHeader.textContent = `Welcome, {{ current_user.username }}`;
    }
    
    await createNewChatAndAssign();
    chatWindow.innerHTML = '';
    input.value = '';
  });

  // Attach listener to server-rendered chat list
  document.querySelectorAll('#recentChats li').forEach(li => {
    li.addEventListener('click', () => {
      const chatId = li.dataset.chatId;
      loadChatById(chatId);
    });
  });

  // Client selection functionality
  function highlightSelectedClient(selectedElement) {
    // Remove highlight from all clients
    document.querySelectorAll('.client-item').forEach(item => {
      item.classList.remove('bg-blue-500/30', 'border-blue-400');
      item.classList.add('bg-white/10');
    });
    
    // Highlight selected client
    if (selectedElement) {
      selectedElement.classList.remove('bg-white/10');
      selectedElement.classList.add('bg-blue-500/30', 'border', 'border-blue-400');
    }
  }

  // Add click listeners to client items
  document.querySelectorAll('.client-item').forEach(clientItem => {
    // Click on client name to start chat
    const clientNameSpan = clientItem.querySelector('.client-name');
    clientNameSpan.addEventListener('click', async () => {
      const clientName = clientItem.dataset.clientName;
      
      // Highlight selected client
      highlightSelectedClient(clientItem);
      
      // Check if client already has a chat - WILL NEED UPDATE ONCE CHAT IS STORED
      try {
        const response = await fetch(`/v1/clients/${encodeURIComponent(clientName)}/chat`);
        const data = await response.json();
        
        if (data.exists) {
          // Load existing chat - WILL NEED UPDATE
          await loadChatById(data.chat_id);
          currentClientName = clientName;
        } else {
          // Create new chat for this client
          await createNewChatAndAssign(clientName);
          chatWindow.innerHTML = '';
          input.value = '';
        }
        
        // Update UI to show client context
        const chatHeader = document.querySelector('nav div:first-child');
        if (chatHeader) {
          chatHeader.textContent = `Chat with ${clientName}`;
        }
      } catch (error) {
        console.error('Error finding client chat:', error);
        // Fallback to creating new chat
        await createNewChatAndAssign(clientName);
        chatWindow.innerHTML = '';
        input.value = '';
      }
    });

    // Edit button click
    const editBtn = clientItem.querySelector('.edit-client-btn');
    editBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const clientName = clientItem.dataset.clientName;
      openEditClientModal(clientName);
    });

    // Delete button click
    const deleteBtn = clientItem.querySelector('.delete-client-btn');
    deleteBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const clientName = clientItem.dataset.clientName;
      deleteClient(clientName);
    });
  });

  // Add Client Modal functionality
  const addClientBtn = document.getElementById('addClientBtn');
  const addClientModal = document.getElementById('addClientModal');
  const addClientForm = document.getElementById('addClientForm');
  const clientNameInput = document.getElementById('clientNameInput');
  const cancelClientBtn = document.getElementById('cancelClientBtn');

  // Edit Client Modal functionality
  const editClientModal = document.getElementById('editClientModal');
  const editClientForm = document.getElementById('editClientForm');
  const editClientNameInput = document.getElementById('editClientNameInput');
  const cancelEditClientBtn = document.getElementById('cancelEditClientBtn');
  let currentEditingClient = null;

  // Show add client modal
  addClientBtn?.addEventListener('click', () => {
    addClientModal.classList.remove('hidden');
    clientNameInput.focus();
  });

  // Hide add client modal
  cancelClientBtn?.addEventListener('click', () => {
    addClientModal.classList.add('hidden');
    clientNameInput.value = '';
  });

  // Hide edit client modal
  cancelEditClientBtn?.addEventListener('click', () => {
    editClientModal.classList.add('hidden');
    editClientNameInput.value = '';
    currentEditingClient = null;
  });

  // Hide modals when clicking outside
  addClientModal?.addEventListener('click', (e) => {
    if (e.target === addClientModal) {
      addClientModal.classList.add('hidden');
      clientNameInput.value = '';
    }
  });

  editClientModal?.addEventListener('click', (e) => {
    if (e.target === editClientModal) {
      editClientModal.classList.add('hidden');
      editClientNameInput.value = '';
      currentEditingClient = null;
    }
  });

  // Open edit client modal
  function openEditClientModal(clientName) {
    currentEditingClient = clientName;
    editClientNameInput.value = clientName;
    editClientModal.classList.remove('hidden');
    editClientNameInput.focus();
  }

  // Delete client function
  async function deleteClient(clientName) {
    if (!confirm(`Are you sure you want to delete client "${clientName}"? This will delete all chat history with this client.`)) {
      return;
    }

    try {
      const response = await fetch(`/v1/clients/${encodeURIComponent(clientName)}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        console.log('Client deleted successfully:', clientName);
        window.location.reload();
      } else {
        const data = await response.json();
        throw new Error(data.error || 'Failed to delete client');
      }
    } catch (error) {
      console.error('Error deleting client:', error);
      alert('Failed to delete client: ' + error.message);
    }
  }

  // Handle add client form submission
  addClientForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const clientName = clientNameInput.value.trim();
    
    if (!clientName) return;

    try {
      const response = await fetch('/v1/clients', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: clientName })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        console.log('Client created successfully:', clientName);
        addClientModal.classList.add('hidden');
        clientNameInput.value = '';
        window.location.reload();
      } else {
        throw new Error(data.error || 'Failed to create client');
      }
      
    } catch (error) {
      console.error('Error creating client:', error);
      alert('Failed to create client: ' + error.message);
    }
  });

  // Handle edit client form submission
  editClientForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newClientName = editClientNameInput.value.trim();
    
    if (!newClientName || !currentEditingClient) return;

    try {
      const response = await fetch(`/v1/clients/${encodeURIComponent(currentEditingClient)}/rename`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_name: newClientName })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        console.log('Client renamed successfully:', currentEditingClient, '->', newClientName);
        editClientModal.classList.add('hidden');
        editClientNameInput.value = '';
        currentEditingClient = null;
        window.location.reload();
      } else {
        throw new Error(data.error || 'Failed to rename client');
      }
      
    } catch (error) {
      console.error('Error renaming client:', error);
      alert('Failed to rename client: ' + error.message);
    }
  });
  async function renameChat(chatId) {
  const newTitle = prompt("Enter new chat title:");
  if (!newTitle) return;

  const res = await fetch('/v1/chat/renamechat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      chat_id: chatId,
      new_title: newTitle
    })
  });

  const data = await res.json();

  if (res.ok) {
    alert("Chat renamed!");
    location.reload(); // refresh to update sidebar titles
  } else {
    alert("Error renaming chat: " + (data.error || "Unknown error"));
  }
}

</script>





</script>

</body>
</html>
